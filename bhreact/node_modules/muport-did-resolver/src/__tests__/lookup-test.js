const ganache = require('ganache-cli')
const bs58 = require('bs58')
const RevokeAndPublishAbi = require('ethereum-claims-registry').applications.RevokeAndPublish.abi
const Web3 = require('web3')
const promisifyAll = require('bluebird').promisifyAll

const { ethLookup } = require('../lookup.js')

const TEST_HASH = 'QmZZBBKPS2NWc6PMZbUk9zUHCo1SHKzQPPX4ndfwaYzmP1'
const RPC_PROV_URL = 'http://localhost:8555'
const CLAIM_KEY = 'muPortDocumentIPFS1220'
const KP = {
  secret: '0x9319b830b14712bd4ab7ede3cef7bfe7f752c5ed8cf66d099a5a14e895c6dceb',
  public: '0291888f1c8cff90aea41cf97dc9b015f2185983524a5e6df888401565239d4d8a',
  address: '0xC94629D67851E1CA43961c3B17964Db3e0b02FFB'
}
const deployData = { "EthereumClaimsRegistry": { "senderAddress": "0x3e5a951e84df3ca6432a1d1f03638e84152f3388", "rawTx": "0xf9071c808502540be4008307b67b8080b906c96060604052341561000f57600080fd5b6106ab8061001e6000396000f30060606040526004361061006d576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680639155b01a146100725780639918925d146100a6578063c7508ec7146100f9578063e1661eff1461015e578063e6d970aa146101df575b600080fd5b341561007d57600080fd5b6100a460048080356000191690602001909190803560001916906020019091905050610260565b005b34156100b157600080fd5b6100f7600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035600019169060200190919080356000191690602001909190505061026f565b005b341561010457600080fd5b61015c600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff169060200190919080356000191690602001909190505061038b565b005b341561016957600080fd5b6101c1600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035600019169060200190919050506105ad565b60405180826000191660001916815260200191505060405180910390f35b34156101ea57600080fd5b610242600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803573ffffffffffffffffffffffffffffffffffffffff169060200190919080356000191690602001909190505061064d565b60405180826000191660001916815260200191505060405180910390f35b61026b33838361026f565b5050565b806000803373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008460001916600019168152602001908152602001600020816000191690555081600019168373ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f8c9f893548e8429f9352aba6698e6f4dca2e390604f6e8c5881a7a505d94ae5084426040518083600019166000191681526020018281526020019250505060405180910390a4505050565b8273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff1614806103f057508173ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff16145b15156103fb57600080fd5b60006001026000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083600019166000191681526020019081526020016000205460001916141515156104a657600080fd5b6000808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600082600019166000191681526020019081526020016000206000905580600019168273ffffffffffffffffffffffffffffffffffffffff163373ffffffffffffffffffffffffffffffffffffffff167f7bc046ef9f2fccd4c99778d7e0fbed67ddb16e63e1a266894769de9516b8039a426040518082815260200191505060405180910390a4505050565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060008473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001908152602001600020600083600019166000191681526020019081526020016000205490509392505050565b6000602052826000526040600020602052816000526040600020602052806000526040600020600092509250505054815600a165627a7a723058200ea8a9224bcc8d15453c0273dd9e5f6d15f2a601d61ecebb0208640123464b2200291ba079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798a00aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "costInEther": 0.00505467, "contractAddress": "0xaca1bcd8d0f5a9bfc95aff331da4c250cd9ac2da" }, "RevokeAndPublish": { "senderAddress": "0x9f450b65e003b42f230eb6599dec5f8bf1617f83", "rawTx": "0xf90805808502540be4008308acc38080b907b2606060405273aca1bcd8d0f5a9bfc95aff331da4c250cd9ac2da600160006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff160217905550341561006457600080fd5b61073f806100736000396000f300606060405260043610610062576000357c0100000000000000000000000000000000000000000000000000000000900463ffffffff1680635dd4a65f146100675780637769d384146100c95780638ac2571f1461013b578063d4d2e7f21461018e575b600080fd5b341561007257600080fd5b6100ab600480803573ffffffffffffffffffffffffffffffffffffffff1690602001909190803560001916906020019091905050610207565b60405180826000191660001916815260200191505060405180910390f35b34156100d457600080fd5b610139600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035600019169060200190919080356000191690602001909190803573ffffffffffffffffffffffffffffffffffffffff16906020019091905050610335565b005b341561014657600080fd5b61018c600480803573ffffffffffffffffffffffffffffffffffffffff16906020019091908035600019169060200190919080356000191690602001909190505061049d565b005b341561019957600080fd5b6101c5600480803573ffffffffffffffffffffffffffffffffffffffff169060200190919050506106e0565b604051808273ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200191505060405180910390f35b6000600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1663e1661eff3085856000604051602001526040518463ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1681526020018373ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200182600019166000191681526020019350505050602060405180830381600087803b151561031257600080fd5b6102c65a03f1151561032357600080fd5b50505060405180519050905092915050565b61034084848461049d565b8073ffffffffffffffffffffffffffffffffffffffff166000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168573ffffffffffffffffffffffffffffffffffffffff167fb108cbcd5a729be24c4a54f8b093f1c6a72c9dcdcbd257cb10e8ead9e69e32f1426040518082815260200191505060405180910390a4806000808673ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060006101000a81548173ffffffffffffffffffffffffffffffffffffffff021916908373ffffffffffffffffffffffffffffffffffffffff16021790555050505050565b60008060008573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff1614801561054c57503373ffffffffffffffffffffffffffffffffffffffff168373ffffffffffffffffffffffffffffffffffffffff16145b806105e057503373ffffffffffffffffffffffffffffffffffffffff166000808573ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16815260200190815260200160002060009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16145b15156105eb57600080fd5b600160009054906101000a900473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff16639918925d8484846040518463ffffffff167c0100000000000000000000000000000000000000000000000000000000028152600401808473ffffffffffffffffffffffffffffffffffffffff1673ffffffffffffffffffffffffffffffffffffffff168152602001836000191660001916815260200182600019166000191681526020019350505050600060405180830381600087803b15156106c757600080fd5b6102c65a03f115156106d857600080fd5b505050505050565b60006020528060005260406000206000915054906101000a900473ffffffffffffffffffffffffffffffffffffffff16815600a165627a7a72305820080031745c3bac9a636032831a5ab09b74d421874ae71513dc90015d0623f55100291ba079be667ef9dcbbac55a06295ce870b07029bfcdb2dce28d959f2815b16f81798a00aaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaaa", "costInEther": 0.00568515, "contractAddress": "0x37c3719cdabd54e6b5195e366f9ef8fc59a509e3" } }

describe('MuPort', () => {

  let recoveredId4
  let server
  let web3
  let accounts
  let revAndPub

  beforeAll(async () => {
    server = promisifyAll(ganache.server({accounts: [{
      secretKey: KP.secret,
      balance: '0x9999999999999999999999999'
    }]}))
    await server.listenAsync(8555)
    web3 = new Web3(server.provider)
    web3.eth = promisifyAll(web3.eth)
    accounts = await web3.eth.getAccountsAsync()
    await deploy(deployData.EthereumClaimsRegistry)
    await deploy(deployData.RevokeAndPublish)
    const RevokeAndPublish = web3.eth.contract(RevokeAndPublishAbi)
    revAndPub = promisifyAll(RevokeAndPublish.at(deployData.RevokeAndPublish.contractAddress))
  })

  it('lookups an ipfs hash from ethereum registry correctly', async () => {
    let hash = await ethLookup(KP.public, RPC_PROV_URL)
    expect(hash).toEqual(null)

    const encHash = encodeIpfsHash(TEST_HASH)
    let txHash = await revAndPub.publishAsync(KP.address, CLAIM_KEY, encHash, {from: KP.address})
    let receipt = await web3.eth.getTransactionReceiptAsync(txHash)
    let h = await revAndPub.lookupAsync(KP.address, CLAIM_KEY)

    hash = await ethLookup(KP.public, RPC_PROV_URL)
    expect(hash).toEqual(TEST_HASH)
  })

  afterAll(() => {
    server.close()
  })

  const deploy = async deployData => {
    await web3.eth.sendTransactionAsync({from: accounts[0], to: deployData.senderAddress, value: web3.toWei(deployData.costInEther, 'ether')})
    let txHash = await web3.eth.sendRawTransactionAsync(deployData.rawTx)
    let receipt = await web3.eth.getTransactionReceiptAsync(txHash)
  }
})

const encodeIpfsHash = (hash) => {
  return '0x' + bs58.decode(hash).toString('hex').slice(4)
}

